<%- include('./layout/header.ejs') %>
<%- include('./../navbar.ejs') %>
<main>
    <div class="row">
        <% 
            // Helper function to convert 24-hour time to 12-hour time with AM/PM
            const convertTo12HourFormat = (time) => {
                const [hour, minute] = time.split(':').map(Number);
                const ampm = hour >= 12 ? 'pm' : 'am';
                const adjustedHour = hour % 12 || 12; // Convert 0 to 12 for 12AM
                return `${adjustedHour}:${minute.toString().padStart(2, '0')}${ampm}`;
            };

            // Helper function to check if a restaurant is open
            const isRestaurantOpen = (restaurant, currentTime) => {
                const now = new Date(currentTime);
                const currentDay = now.toLocaleString('en-US', { weekday: 'long' });
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();

                return restaurant.openingHours.some(opening => {
                    if (opening.day === currentDay && opening.isOpen) {
                        const [openHour, openMinute] = opening.open.split(':').map(Number);
                        const [closeHour, closeMinute] = opening.close.split(':').map(Number);

                        const openTime = openHour * 60 + openMinute;
                        const closeTime = closeHour * 60 + closeMinute;
                        const currentTimeInMinutes = currentHour * 60 + currentMinute;

                        return currentTimeInMinutes >= openTime && currentTimeInMinutes <= closeTime;
                    }
                    return false;
                });
            };

            // Helper function to get the open days
            const getOpenDays = (openingHours) => {
                return openingHours
                    .filter(opening => opening.isOpen)
                    .map(opening => opening.day)
                    .join(', ');
            };
        %>

        <% restaurants.forEach(restaurant => { %>
            <% if (restaurant.statusIsActive) { %> 
                <% let hideSquare = customerQuota.some(quota => quota.restaurant && quota.restaurant._id.toString() === restaurant._id.toString() && quota.cancelledLimit === 0); %>

                <div class="square<%= hideSquare ? ' d-none' : '' %>">
                    <% let isOpen = isRestaurantOpen(restaurant, currentTime); %>

                    <% if (!isOpen) { %>
                        <a class="card mb-4 shadow-sm text-decoration-none">                     
                    <% } else { %>
                        <a href="/restaurant-products/<%= restaurant.lowername %>" class="card mb-4 shadow-sm text-decoration-none">                     
                    <% } %>
                        <img src="/images/restaurant/<%= restaurant.lowername %>/banner/<%= restaurant.image %>" class="card-img-top restaurant-banner-image" alt="<%= restaurant.name %>">

                        <div class="card-body">
                            <% if (!isOpen) { %>
                                <small class="bg-danger text-white py-1 px-2">CLOSED</small>
                            <% } %>
                            <h5 class="card-title mt-2"><%= restaurant.name %></h5>
                            <p class="card-text"><%= restaurant.address %></p>
                            <% if (isOpen && restaurant.openingHours && restaurant.openingHours.length > 0 && restaurant.openingHours[0].open && restaurant.openingHours[0].close) { %>
                                <small>
                                    From <%= convertTo12HourFormat(restaurant.openingHours[0].open) %> to <%= convertTo12HourFormat(restaurant.openingHours[0].close) %>
                                </small>
                            <% } else { %>
                                <!-- <small class="text-muted">Opening hours not available</small> -->
                            <% } %>
                        </div>
                    </a>
                </div>
            <% } %>
        <% }) %>
    </div>
</main>




<script src="/js/customer/home.js"></script>            
<%- include('.././footer.ejs') %>
